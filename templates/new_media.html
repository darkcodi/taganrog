{% extends "base.html" %}

{% block content %}
<div class="flex flex-col h-screen">
    {% include "search_header.html" %}
    <main class="h-screen flex flex-col items-center justify-center bg-white px-4 sm:px-6 lg:px-8">
        <div class="max-w-7xl w-full mt-6 grid grid-cols-1 gap-4 bg-gray-50">
            <div class="rounded-md shadow-sm p-4">
                <h2 class="text-2xl font-bold mt-2">
                    Tag new file(s)
                </h2>
                <div class="mt-4">
                    <button class="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 focus:z-10 sm:text-sm"
                           id="fileInput">
                        Choose file(s)
                    </button>
                </div>
                <div class="container mt-4 mx-auto px-4">
                    <div id="preview-container" class="grid grid-cols-7 gap-4"></div>
                </div>
                <div id="tags-div">
                </div>
            </div>
        </div>
    </main>
    <footer class="w-full h-20 flex items-center justify-center bg-white">
        <div class="text-center">
            <a class="text-gray-600" href="/media/random">Charting digital depths, from Alferaki to Faina</a>
        </div>
    </footer>
    <script>
        const generateThumbnail = (src, mimeType) => {
            return new Promise((resolve) => {
                if (mimeType.startsWith('image')) {
                    return generateImageThumbnail(src).then(resolve);
                }

                if (mimeType.startsWith('video')) {
                    return generateVideoThumbnail(src).then(resolve);
                }

                return resolve(null);
            });
        };
        const generateVideoThumbnail = (src) => {
            return new Promise((resolve) => {
                const canvas = document.createElement("canvas");
                const video = document.createElement("video");
                video.crossOrigin = "anonymous";
                video.autoplay = true;
                video.muted = true;
                video.src = src;
                video.onloadeddata = () => {
                    let ctx = canvas.getContext("2d");
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    ctx.drawImage(video, 0, 0, video.videoWidth, video.videoHeight);
                    video.pause();
                    return resolve(canvas.toDataURL("image/png"));
                };
            });
        };
        const generateImageThumbnail = (src) => {
            return new Promise((resolve) => {
                const img = document.createElement("img");
                img.crossOrigin = "anonymous";
                img.src = src;
                img.onload = () => {
                    const canvas = document.createElement("canvas");
                    const ctx = canvas.getContext("2d");
                    canvas.width = img.width;
                    canvas.height = img.height;
                    ctx.drawImage(img, 0, 0, img.width, img.height);
                    return resolve(canvas.toDataURL("image/png"));
                };
            });
        };
        const addPreviewForMedia = async (media) => {
            const previewContainer = document.getElementById('preview-container');

            const media_id = media.id;
            const mimeType = media.content_type;
            const filepath = media.location;
            const normalizedFilepath = convertFileSrc(filepath, 'stream');
            console.log('Normalized filepath:', normalizedFilepath);

            const has_thumbnail = await invoke('has_thumbnail', {media_id});

            if (has_thumbnail) {
                console.log('Thumbnail already exists');

                const img = document.createElement('img');
                img.src = media.thumbnail_location_url;
                img.classList.add('w-32', 'h-32', 'object-cover', 'rounded-md', 'file-preview');
                previewContainer.appendChild(img);
            } else {
                const thumbnail = await generateThumbnail(normalizedFilepath, mimeType);
                if (!thumbnail) {
                    console.error('Failed to generate thumbnail');
                    return;
                }

                await invoke('save_thumbnail', {media_id, thumbnail});
                console.log('Saved new thumbnail');

                const img = document.createElement('img');
                img.src = thumbnail;
                img.classList.add('w-32', 'h-32', 'object-cover', 'rounded-md', 'file-preview');
                previewContainer.appendChild(img);
            }
        };
        window.addEventListener('DOMContentLoaded', () => {
            const previewContainer = document.getElementById('preview-container');

            document.getElementById('fileInput').addEventListener('click', async () => {
                while (previewContainer.firstChild) {
                    previewContainer.removeChild(previewContainer.firstChild);
                }

                const files = await invoke('choose_files');
                if (!files || files.length === 0) {
                    console.error('No files chosen');
                    return;
                }

                if (files.length === 1) {
                    let media = await invoke('load_media_from_file', { path_str: files[0] });
                    console.log('Chosen media:', media);

                    await addPreviewForMedia(media);

                    // TODO: redirect to /preview page?
                }
                else {
                    for (const path_str of files) {
                        let media = await invoke('load_media_from_file', { path_str });
                        console.log('Chosen media:', media);

                        await addPreviewForMedia(media);
                    }

                    // TODO: unhide input for tags and submit button
                }
            });
        });
    </script>
</div>
{% endblock %}
